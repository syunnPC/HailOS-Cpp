#include "basetype.hpp"
#include "init.hpp"
#include "kernellib.hpp"

#define GEN_INT_STUB(i) static inline void interrupt##i(){asm volatile("int $" #i ::: "memory");}
#define P(i) interrupt##i

namespace HailOS::Kernel::Debug
{
    static inline void lidt(const Boot::IDTR* idtr)
    {
        asm volatile("lidt (%0)" : : "r"(idtr) : "memory");
    }

    static inline void sidt(Boot::IDTR* idtr)
    {
        asm volatile("sidt (%0)" : "=m"(*idtr) : : "memory");
    }

    using Stub = void(*)();

    GEN_INT_STUB(0)
    GEN_INT_STUB(1)
    GEN_INT_STUB(2)
    GEN_INT_STUB(3)
    GEN_INT_STUB(4)
    GEN_INT_STUB(5)
    GEN_INT_STUB(6)
    GEN_INT_STUB(7)
    GEN_INT_STUB(8)
    GEN_INT_STUB(9)
    GEN_INT_STUB(10)
    GEN_INT_STUB(11)
    GEN_INT_STUB(12)
    GEN_INT_STUB(13)
    GEN_INT_STUB(14)
    GEN_INT_STUB(15)
    GEN_INT_STUB(16)
    GEN_INT_STUB(17)
    GEN_INT_STUB(18)
    GEN_INT_STUB(19)
    GEN_INT_STUB(20)
    GEN_INT_STUB(21)
    GEN_INT_STUB(22)
    GEN_INT_STUB(23)
    GEN_INT_STUB(24)
    GEN_INT_STUB(25)
    GEN_INT_STUB(26)
    GEN_INT_STUB(27)
    GEN_INT_STUB(28)
    GEN_INT_STUB(29)
    GEN_INT_STUB(30)
    GEN_INT_STUB(31)
    GEN_INT_STUB(32)
    GEN_INT_STUB(33)
    GEN_INT_STUB(34)
    GEN_INT_STUB(35)
    GEN_INT_STUB(36)
    GEN_INT_STUB(37)
    GEN_INT_STUB(38)
    GEN_INT_STUB(39)
    GEN_INT_STUB(40)
    GEN_INT_STUB(41)
    GEN_INT_STUB(42)
    GEN_INT_STUB(43)
    GEN_INT_STUB(44)
    GEN_INT_STUB(45)
    GEN_INT_STUB(46)
    GEN_INT_STUB(47)
    GEN_INT_STUB(48)
    GEN_INT_STUB(49)
    GEN_INT_STUB(50)
    GEN_INT_STUB(51)
    GEN_INT_STUB(52)
    GEN_INT_STUB(53)
    GEN_INT_STUB(54)
    GEN_INT_STUB(55)
    GEN_INT_STUB(56)
    GEN_INT_STUB(57)
    GEN_INT_STUB(58)
    GEN_INT_STUB(59)
    GEN_INT_STUB(60)
    GEN_INT_STUB(61)
    GEN_INT_STUB(62)
    GEN_INT_STUB(63)
    GEN_INT_STUB(64)
    GEN_INT_STUB(65)
    GEN_INT_STUB(66)
    GEN_INT_STUB(67)
    GEN_INT_STUB(68)
    GEN_INT_STUB(69)
    GEN_INT_STUB(70)
    GEN_INT_STUB(71)
    GEN_INT_STUB(72)
    GEN_INT_STUB(73)
    GEN_INT_STUB(74)
    GEN_INT_STUB(75)
    GEN_INT_STUB(76)
    GEN_INT_STUB(77)
    GEN_INT_STUB(78)
    GEN_INT_STUB(79)
    GEN_INT_STUB(80)
    GEN_INT_STUB(81)
    GEN_INT_STUB(82)
    GEN_INT_STUB(83)
    GEN_INT_STUB(84)
    GEN_INT_STUB(85)
    GEN_INT_STUB(86)
    GEN_INT_STUB(87)
    GEN_INT_STUB(88)
    GEN_INT_STUB(89)
    GEN_INT_STUB(90)
    GEN_INT_STUB(91)
    GEN_INT_STUB(92)
    GEN_INT_STUB(93)
    GEN_INT_STUB(94)
    GEN_INT_STUB(95)
    GEN_INT_STUB(96)
    GEN_INT_STUB(97)
    GEN_INT_STUB(98)
    GEN_INT_STUB(99)
    GEN_INT_STUB(100)
    GEN_INT_STUB(101)
    GEN_INT_STUB(102)
    GEN_INT_STUB(103)
    GEN_INT_STUB(104)
    GEN_INT_STUB(105)
    GEN_INT_STUB(106)
    GEN_INT_STUB(107)
    GEN_INT_STUB(108)
    GEN_INT_STUB(109)
    GEN_INT_STUB(110)
    GEN_INT_STUB(111)
    GEN_INT_STUB(112)
    GEN_INT_STUB(113)
    GEN_INT_STUB(114)
    GEN_INT_STUB(115)
    GEN_INT_STUB(116)
    GEN_INT_STUB(117)
    GEN_INT_STUB(118)
    GEN_INT_STUB(119)
    GEN_INT_STUB(120)
    GEN_INT_STUB(121)
    GEN_INT_STUB(122)
    GEN_INT_STUB(123)
    GEN_INT_STUB(124)
    GEN_INT_STUB(125)
    GEN_INT_STUB(126)
    GEN_INT_STUB(127)
    GEN_INT_STUB(128)
    GEN_INT_STUB(129)
    GEN_INT_STUB(130)
    GEN_INT_STUB(131)
    GEN_INT_STUB(132)
    GEN_INT_STUB(133)
    GEN_INT_STUB(134)
    GEN_INT_STUB(135)
    GEN_INT_STUB(136)
    GEN_INT_STUB(137)
    GEN_INT_STUB(138)
    GEN_INT_STUB(139)
    GEN_INT_STUB(140)
    GEN_INT_STUB(141)
    GEN_INT_STUB(142)
    GEN_INT_STUB(143)
    GEN_INT_STUB(144)
    GEN_INT_STUB(145)
    GEN_INT_STUB(146)
    GEN_INT_STUB(147)
    GEN_INT_STUB(148)
    GEN_INT_STUB(149)
    GEN_INT_STUB(150)
    GEN_INT_STUB(151)
    GEN_INT_STUB(152)
    GEN_INT_STUB(153)
    GEN_INT_STUB(154)
    GEN_INT_STUB(155)
    GEN_INT_STUB(156)
    GEN_INT_STUB(157)
    GEN_INT_STUB(158)
    GEN_INT_STUB(159)
    GEN_INT_STUB(160)
    GEN_INT_STUB(161)
    GEN_INT_STUB(162)
    GEN_INT_STUB(163)
    GEN_INT_STUB(164)
    GEN_INT_STUB(165)
    GEN_INT_STUB(166)
    GEN_INT_STUB(167)
    GEN_INT_STUB(168)
    GEN_INT_STUB(169)
    GEN_INT_STUB(170)
    GEN_INT_STUB(171)
    GEN_INT_STUB(172)
    GEN_INT_STUB(173)
    GEN_INT_STUB(174)
    GEN_INT_STUB(175)
    GEN_INT_STUB(176)
    GEN_INT_STUB(177)
    GEN_INT_STUB(178)
    GEN_INT_STUB(179)
    GEN_INT_STUB(180)
    GEN_INT_STUB(181)
    GEN_INT_STUB(182)
    GEN_INT_STUB(183)
    GEN_INT_STUB(184)
    GEN_INT_STUB(185)
    GEN_INT_STUB(186)
    GEN_INT_STUB(187)
    GEN_INT_STUB(188)
    GEN_INT_STUB(189)
    GEN_INT_STUB(190)
    GEN_INT_STUB(191)
    GEN_INT_STUB(192)
    GEN_INT_STUB(193)
    GEN_INT_STUB(194)
    GEN_INT_STUB(195)
    GEN_INT_STUB(196)
    GEN_INT_STUB(197)
    GEN_INT_STUB(198)
    GEN_INT_STUB(199)
    GEN_INT_STUB(200)
    GEN_INT_STUB(201)
    GEN_INT_STUB(202)
    GEN_INT_STUB(203)
    GEN_INT_STUB(204)
    GEN_INT_STUB(205)
    GEN_INT_STUB(206)
    GEN_INT_STUB(207)
    GEN_INT_STUB(208)
    GEN_INT_STUB(209)
    GEN_INT_STUB(210)
    GEN_INT_STUB(211)
    GEN_INT_STUB(212)
    GEN_INT_STUB(213)
    GEN_INT_STUB(214)
    GEN_INT_STUB(215)
    GEN_INT_STUB(216)
    GEN_INT_STUB(217)
    GEN_INT_STUB(218)
    GEN_INT_STUB(219)
    GEN_INT_STUB(220)
    GEN_INT_STUB(221)
    GEN_INT_STUB(222)
    GEN_INT_STUB(223)
    GEN_INT_STUB(224)
    GEN_INT_STUB(225)
    GEN_INT_STUB(226)
    GEN_INT_STUB(227)
    GEN_INT_STUB(228)
    GEN_INT_STUB(229)
    GEN_INT_STUB(230)
    GEN_INT_STUB(231)
    GEN_INT_STUB(232)
    GEN_INT_STUB(233)
    GEN_INT_STUB(234)
    GEN_INT_STUB(235)
    GEN_INT_STUB(236)
    GEN_INT_STUB(237)
    GEN_INT_STUB(238)
    GEN_INT_STUB(239)
    GEN_INT_STUB(240)
    GEN_INT_STUB(241)
    GEN_INT_STUB(242)
    GEN_INT_STUB(243)
    GEN_INT_STUB(244)
    GEN_INT_STUB(245)
    GEN_INT_STUB(246)
    GEN_INT_STUB(247)
    GEN_INT_STUB(248)
    GEN_INT_STUB(249)
    GEN_INT_STUB(250)
    GEN_INT_STUB(251)
    GEN_INT_STUB(252)
    GEN_INT_STUB(253)
    GEN_INT_STUB(254)
    GEN_INT_STUB(255)

    static constexpr Stub INT_STUBS[256] =
    {
        P(0),
        P(1),
        P(2),
        P(3),
        P(4),
        P(5),
        P(6),
        P(7),
        P(8),
        P(9),
        P(10),
        P(11),
        P(12),
        P(13),
        P(14),
        P(15),
        P(16),
        P(17),
        P(18),
        P(19),
        P(20),
        P(21),
        P(22),
        P(23),
        P(24),
        P(25),
        P(26),
        P(27),
        P(28),
        P(29),
        P(30),
        P(31),
        P(32),
        P(33),
        P(34),
        P(35),
        P(36),
        P(37),
        P(38),
        P(39),
        P(40),
        P(41),
        P(42),
        P(43),
        P(44),
        P(45),
        P(46),
        P(47),
        P(48),
        P(49),
        P(50),
        P(51),
        P(52),
        P(53),
        P(54),
        P(55),
        P(56),
        P(57),
        P(58),
        P(59),
        P(60),
        P(61),
        P(62),
        P(63),
        P(64),
        P(65),
        P(66),
        P(67),
        P(68),
        P(69),
        P(70),
        P(71),
        P(72),
        P(73),
        P(74),
        P(75),
        P(76),
        P(77),
        P(78),
        P(79),
        P(80),
        P(81),
        P(82),
        P(83),
        P(84),
        P(85),
        P(86),
        P(87),
        P(88),
        P(89),
        P(90),
        P(91),
        P(92),
        P(93),
        P(94),
        P(95),
        P(96),
        P(97),
        P(98),
        P(99),
        P(100),
        P(101),
        P(102),
        P(103),
        P(104),
        P(105),
        P(106),
        P(107),
        P(108),
        P(109),
        P(110),
        P(111),
        P(112),
        P(113),
        P(114),
        P(115),
        P(116),
        P(117),
        P(118),
        P(119),
        P(120),
        P(121),
        P(122),
        P(123),
        P(124),
        P(125),
        P(126),
        P(127),
        P(128),
        P(129),
        P(130),
        P(131),
        P(132),
        P(133),
        P(134),
        P(135),
        P(136),
        P(137),
        P(138),
        P(139),
        P(140),
        P(141),
        P(142),
        P(143),
        P(144),
        P(145),
        P(146),
        P(147),
        P(148),
        P(149),
        P(150),
        P(151),
        P(152),
        P(153),
        P(154),
        P(155),
        P(156),
        P(157),
        P(158),
        P(159),
        P(160),
        P(161),
        P(162),
        P(163),
        P(164),
        P(165),
        P(166),
        P(167),
        P(168),
        P(169),
        P(170),
        P(171),
        P(172),
        P(173),
        P(174),
        P(175),
        P(176),
        P(177),
        P(178),
        P(179),
        P(180),
        P(181),
        P(182),
        P(183),
        P(184),
        P(185),
        P(186),
        P(187),
        P(188),
        P(189),
        P(190),
        P(191),
        P(192),
        P(193),
        P(194),
        P(195),
        P(196),
        P(197),
        P(198),
        P(199),
        P(200),
        P(201),
        P(202),
        P(203),
        P(204),
        P(205),
        P(206),
        P(207),
        P(208),
        P(209),
        P(210),
        P(211),
        P(212),
        P(213),
        P(214),
        P(215),
        P(216),
        P(217),
        P(218),
        P(219),
        P(220),
        P(221),
        P(222),
        P(223),
        P(224),
        P(225),
        P(226),
        P(227),
        P(228),
        P(229),
        P(230),
        P(231),
        P(232),
        P(233),
        P(234),
        P(235),
        P(236),
        P(237),
        P(238),
        P(239),
        P(240),
        P(241),
        P(242),
        P(243),
        P(244),
        P(245),
        P(246),
        P(247),
        P(248),
        P(249),
        P(250),
        P(251),
        P(252),
        P(253),
        P(254),
        P(255)
    };

    static constexpr Boot::IDTR BAD_IDT = {0, 0};

    [[noreturn]] inline void kill(u8 vec)
    {
        Utility::setForceDisableInterrupt(true);
        Utility::disableInterrupts();
        lidt(&BAD_IDT);
        INT_STUBS[vec]();
        Utility::haltProcessor();
    }

    [[noreturn]] void dbgTripleFaultTrace(u8 interrupt)
    {
        kill(interrupt);
    }
}